<div class="header">
  <%= link_to tasks_path, class: "back-button" do %>
    <i class="fa-solid fa-arrow-left"></i>
  <% end %>

  <h1 class="header-title"><%= @task.title %></h1>

  <% if policy(@task).edit? %>
    <div class="dropdown">
      <button class="dropbtn"><i class="fas fa-ellipsis-v"></i></button>
      <div class="dropdown-content">
        <%= link_to 'Edit', edit_task_path(@task), class: "dropdown-item" %>
        <%= button_to 'Delete Task', task_path(@task), method: :delete, data: { turbo_confirm: 'Are you sure?' }, class: "dropdown-item" %>
      </div>
    </div>
  <% end %>
</div>

<div class="task-section description-section">
  <h3>Descriptions</h3>
  <p><%= @task.description %></p>
</div>

<div class="task-section assigned-section">
  <h3>Assigned Staff</h3>
  <%= turbo_frame_tag "task_users" do %>
    <div class="staff-list">
      <ul>
        <% @task.user_tasks.each do |user_task| %>
          <li id="user_task_<%= user_task.id %>" class="staff-member">
            <div class="avatar-container">
              <%= image_tag(user_task.user.avatar, alt: "#{user_task.user.first_name}'s avatar", class: "staff-avatar") if user_task.user.avatar.attached? %>
              <% if policy(@task).edit? %>
                <%= button_to '', user_task_path(user_task), method: :delete, data: { turbo_confirm: 'Are you sure?' }, class: "remove-staff-btn" %>
              <% end %>
            </div>
            <span class="staff-name"><%= user_task.user.first_name %></span>
          </li>
        <% end %>
        <% end %>
        <% if policy(@task).edit? %>
          <div class="add-user-container" data-controller="add-user">
            <%= form_with url: add_user_task_path(@task), method: :post, id: "add-user-form", remote: true do |form| %>
              <div class="add-member-button" >+</div>
              <%= select_tag :user_id, options_from_collection_for_select(User.all, :id, :first_name, { include_blank: true }), id: 'user-select', class: "user-select", data: { add_user_target: "select" }, onchange: "this.form.submit();" %>
            <% end %>
            <span class="staff-name">Add Staff</span>
          </div>
        <% end %>
       </ul>
    </div>
</div>

<div class="task-section-priority">
  <% if policy(@task).edit? %>
    <%= form_with model: @task, url: task_path(@task), method: :patch, local: true do |form| %>
      <div class="field">
        <%= form.label :priority, 'Priority:' %>
        <%= form.select :priority, Task.priorities.keys.map { |priority| [priority.capitalize, priority] }, {}, { class: "prio-select", onchange: "this.form.submit();" } %>
      </div>
    <% end %>
  <% else %>
    <p>Priority: <%= @task.priority.capitalize %></p>
  <% end %>
</div>

<h3>Comments:</h3>
<%= turbo_frame_tag "comments" do %>
  <% @task.task_comments.each do |comment| %>
    <%= render "comments/comment", comment: comment %>
  <% end %>
<% end %>

<h3>Add a Comment:</h3>
<%= turbo_frame_tag "new_comment" do %>
  <%= form_with model: [ @task, TaskComment.new ], url: task_comments_path(@task), id: "new_comment_form", local: true do |form| %>
    <div data-controller="mentions" data-action="keyup->mentions#keyup">
      <%= form.label :content, 'Your Comment:' %>
      <%= form.text_area :content, data: { mentions_target: "input" } %>
      <%= form.file_field :file, accept: 'application/pdf,image/png,image/jpeg' %>
      <div data-mentions-target="suggestions" class="suggestions-container hidden"></div>
    </div>
    <div>
      <%= form.submit 'Submit Comment', data: { turbo_frame: "new_comment" } %>
    </div>
  <% end %>
<% end %>

<%= form_with model: @task, url: toggle_completion_task_path(@task), method: :patch, id: "task_completion_form_#{@task.id}", data: { turbo_frame: "task_#{@task.id}" } do |form| %>
  <div class="form-check form-switch">
    <%= form.check_box :completed, class: "form-check-input", id: "completedSwitch#{@task.id}", onchange: "this.form.submit();" %>
    <%= form.label :completed, 'Completed:', class: "form-check-label", for: "completedSwitch#{@task.id}" %>
  </div>
<% end %>
